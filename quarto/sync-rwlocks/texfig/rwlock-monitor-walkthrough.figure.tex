\documentclass[tikz]{standalone}
\input{common/tikzBase}
\usetikzlibrary{fit,matrix,shapes.callouts,calc}
\lstset{
    language=C++,
    basicstyle=\fontsize{8.5}{9.5}\tt\selectfont,
    moredelim={**[is][\btHL<1->]{@1}{1@}},
}
\tikzset{btHLbox/.append style={fill=blue!20}}
\newsavebox\rwLockPlusReaders
\newsavebox\rwLockPlusWriters
\newsavebox\rwLockMinusReaders
\newsavebox\rwLockMinusReadersSignal
\newsavebox\rwLockWriterGo
\newsavebox\rwLockReaderGoWriter
\newsavebox\rwLockReaderGoEnd
\begin{document}
\begin{lrbox}{\rwLockPlusReaders}
\begin{lstlisting}
mutex_lock(&lock);
while (@1writers != 0 || waiting_writers != 01@) {
  cond_wait(&ok_to_read_cv, &lock);
}
@1++readers;1@
mutex_unlock(&lock);
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\rwLockPlusWriters}
\tikzset{btHLbox/.append style={fill=yellow!20}}
\begin{lstlisting}
mutex_lock(&lock);
++waiting_writers;
while (@1readers + writers != 01@) {
  @1cond_wait(&ok_to_write_cv, &lock);1@
}
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\rwLockMinusReaders}
\tikzset{btHLbox/.append style={fill=blue!20}}
\begin{lstlisting}
mutex_lock(&lock);
@1--readers;1@
if (readers == 0)
  ...
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\rwLockMinusReadersSignal}
\tikzset{btHLbox/.append style={fill=green!20}}
\begin{lstlisting}
mutex_lock(&lock);
--readers;
if (readers == 0)
  @1cond_signal(&ok_to_write_cv)1@
mutex_unlock(&lock);
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\rwLockWriterGo}
\tikzset{btHLbox/.append style={fill=yellow!30}}
\begin{lstlisting}
while (@1readers + writers != 01@) {
  cond_wait(&ok_to_write_cv, &lock);
}
@1--waiting_writers; ++writers;1@
mutex_unlock(&lock);
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\rwLockReaderGoWriter}
\tikzset{btHLbox/.append style={fill=yellow!30}}
\begin{lstlisting}
mutex_lock(&lock);
if (waiting_writers != 0) {
  cond_signal(&ok_to_write_cv);
} else {
  @1cond_broadcast(&ok_to_read_cv);1@
}
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\rwLockReaderGoEnd}
\tikzset{btHLbox/.append style={fill=violet!20}}
\begin{lstlisting}
while (writers != 0 && waiting_writers != 0) {
  cond_wait(&ok_to_read_cv, &lock);
}
@1++readers;1@
mutex_unlock(&lock);
\end{lstlisting}
\end{lrbox}

\setSlide{1}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{2}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{3}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{4}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{5}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{6}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{7}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{8}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{9}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{10}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{11}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{12}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\setSlide{13}
\input{sync-rwlocks/texfig/rwlock-monitor-walkthrough.inner.tex}
\end{document}
