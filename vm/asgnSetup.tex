\usetikzlibrary{matrix}
\begin{frame}{pagetable assignment}
    \begin{itemize}
    \item pagetable assignment
    \item simulate page tables (on top of normal program memory)
        \begin{itemize}
            \item alternately: implement another layer of page tables \\
                on top of the existing system's
        \end{itemize}
    \vspace{.5cm}
    \item in assignment:
    \item virtual address $\sim$ arguments to your functions
    \item physical address $\sim$ your program addresses (normal pointers)
    \end{itemize}
\end{frame}

\begin{frame}[fragile,label=asgnAPI]{pagetable assignment API}
\lstset{language=C,style=smaller}
\begin{lstlisting}
/* configuration parameters */
#define POBITS ...
#define LEVELS /* later /
\end{lstlisting}
\hrule
\begin{lstlisting}
size_t ptbr; // page table base register
    // points to page table (array of page table entries)

// lookup "virtual" address 'va' in page table ptbr points to
// return (void*) (~0L) if invalid
void *translate(size_t va);

// make it so 'va' is valid, allocating one page for its data
// if it isn't already
void page_allocate(size_t va)
\end{lstlisting}
\end{frame}

\begin{frame}{translate()}
    with POBITS=\myemph<2>{12}, LEVELS=1: \\
\begin{tikzpicture}
    \node (ptbreq) {ptbr = GetPointerToTable(};
    \matrix[tight matrix,anchor=west,
        nodes={minimum height=0.5cm},
        row 1/.style={
            nodes={draw=none},
        },
        column 2/.style={
            nodes={text width=1.2cm}
        },
        column 3/.style={
            nodes={text width=2.2cm}
        },
    ] (tbl) at (ptbreq.east) {
        VPN \& valid? \& physical \\
        0 \& 0 \& --- \\
        1 \& 1 \& 0x9999 \\
        2 \& 0 \& --- \\
        3 \& 1 \& 0x3333 \\
        \ldots \& \ldots \& \ldots \\
    };
    \node[anchor=west] (ptbrparen) at (tbl.east) {)};
    \node[align=left,
    anchor=north west] at (tbl.south -| ptbreq.west) {
        translate(0x0\myemph<2>{FFF}) == (void*) \~0L \\
        translate(0x1\myemph<2>{000}) == (void*) 0x9999\myemph<2>{000} \\
        translate(0x1\myemph<2>{001}) == (void*) 0x9999\myemph<2>{001} \\
        translate(0x2\myemph<2>{000}) == (void*) \~0L \\
        translate(0x2\myemph<2>{001}) == (void*) \~0L \\
        translate(0x3\myemph<2>{000}) == (void*) 0x3333\myemph<2>{000} \\
    };
\end{tikzpicture}
\end{frame}

\begin{frame}{allocate()}
    with POBITS=\myemph<2>{12}, LEVELS=1: \\
\begin{tikzpicture}
    \node (ptbrzero) {ptbr == 0}
    \node (pgalloc) {page\_allocate(0x1000) \textit{or} page\_allocate(0x1001) \textit{or} \ldots}
    \node (ptbreq) {ptbr \textit{now points to} GetPointerToTable(};
    \matrix[tight matrix,anchor=west,
        nodes={minimum height=0.5cm},
        row 1/.style={
            nodes={draw=none},
        },
        column 2/.style={
            nodes={text width=1.2cm}
        },
        column 3/.style={
            nodes={text width=2.2cm}
        },
    ] (tbl) at (ptbreq.east) {
        VPN \& valid? \& physical \\
        0 \& 0 \& --- \\
        1 \& 1 \& \myemph{page number of newly allocated memory} \\ 
        2 \& 0 \& --- \\
        3 \& 1 \& --- \\
        \ldots \& \ldots \& \ldots \\
    };
\end{tikzpicture}
\end{frame}
