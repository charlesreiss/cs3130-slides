
\begin{frame}[fragile,label=semaphoreMonitorNoBCast2A]{semaphores with monitors: no condition}
\lstset{
    language=C++,
    basicstyle=\fontsize{9}{10}\tt\selectfont,
    morekeywords=pthread_mutex_t,
    morekeywords=pthread_cond_t,
    moredelim={**[is][\btHL<1|handout:1>]{@1}{1@}},
}
\begin{lstlisting}
pthread_mutex_t lock;
unsigned int count;
/* condition, broadcast when becomes count > 0 */
pthread_cond_t count_is_positive_cv;
\end{lstlisting}
\begin{minipage}{0.45\textwidth}
\begin{lstlisting}
void down() {
    pthread_mutex_lock(&lock);
    while (!(count > 0)) {
        pthread_cond_wait(
            &count_is_positive_cv,
            &lock);
    }
    count -= 1;
    pthread_mutex_unlock(&lock);
}
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\begin{lstlisting}
void up() {
    pthread_mutex_lock(&lock);
    count += 1;
    @1pthread_cond_signal1@(
        &count_is_positive_cv
    );
    pthread_mutex_unlock(&lock);
}
\end{lstlisting}
\end{minipage}
    \begin{itemize}
        \item same as where we started\ldots
    \end{itemize}
\end{frame}

\begin{frame}[fragile,label=semaphoreMonitorBCast2B]{semaphores with monitors: alt w/ signal}
\lstset{
    language=C++,
    basicstyle=\fontsize{9}{10}\tt\selectfont,
    morekeywords=pthread_mutex_t,
    morekeywords=pthread_cond_t,
    moredelim={**[is][\btHL<1|handout:1>]{@1}{1@}},
}
\begin{lstlisting}
pthread_mutex_t lock;
unsigned int count;
/* condition, broadcast when becomes count > 0 */
pthread_cond_t count_is_positive_cv;
\end{lstlisting}
\begin{minipage}{0.45\textwidth}
\begin{lstlsiting}
void down() {
    pthread_mutex_lock(&lock);
    while (!(count > 0)) {
        pthread_cond_wait(
            &count_is_positive_cv,
            &lock);
    }
    count -= 1;
    @1if (count > 0) {1@
        @1pthread_cond_signal(1@
            &count_is_positive_cv
        );
    }
    pthread_mutex_unlock(&lock);
}
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\begin{lstlisting}
void up() {
    pthread_mutex_lock(&lock);
    count += 1;
    if (count == 1) {
        @1pthread_cond_signal1@(
            &count_is_positive_cv
        );
    }
    pthread_mutex_unlock(&lock);
}
\end{lstlisting}
\end{minipage}
\end{frame}

\begin{frame}{on signal/broadcast generally}
    \begin{itemize}
    \item whenever using signal need to ask \\
        what if more than one thread is waiting?
    \item need to explain why those threads will be signalled eventually
    \item \ldots \myemph{even if next thread signalled doesn't run right away}
    \vspace{.5cm}
    \item another problem that would be avoided with Hoare scheduling
    \end{itemize}
\end{frame}
