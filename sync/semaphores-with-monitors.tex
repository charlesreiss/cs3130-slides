\begin{frame}[fragile,label=semaphoreWithMonitors]\frametitle{building semaphore with monitors}
\lstset{
    language=C++,
    basicstyle=\fontsize{9}{10}\tt\selectfont,
    morekeywords=pthread_mutex_t,
    morekeywords=pthread_cond_t,
}
\begin{lstlisting}
pthread_mutex_t lock;
\end{lstlisting}
\begin{visibleenv}<2->
\begin{lstlisting}
unsigned int count;
\end{lstlisting}
\begin{visibleenv}<3->
\begin{lstlisting}
/* condition, broadcast when becomes count > 0 */
pthread_cond_t count_is_positive_cv;
\end{lstlisting}
\end{visibleenv}
\begin{minipage}{0.45\textwidth}
\begin{visibleenv}<4->
\begin{lstlisting}
void down() {
    pthread_mutex_lock(&lock);
    while (!(count > 0)) {
        pthread_cond_wait(
            &count_is_positive_cv,
            &lock);
    }
    count -= 1;
    pthread_mutex_unlock(&lock);
}
\end{lstlisting}
\end{minipage}
\begin{minipage}{0.45\textwidth}
\begin{visibleenv}<5->
\begin{lstlisting}
void up() {
    pthread_mutex_lock(&lock);
    count += 1;
    /* count must now be
       positive, and at most
       one thread can go per
       call to Up() */
    pthread_cond_signal(
        &count_is_positive_cv
    );
    pthread_mutex_unlock(&lock);
}
\end{lstlisting}
\end{minipage}
\begin{itemize}
\item<1-> \myemph<1>{lock to protect shared state}
    \begin{itemize}
    \item<2-> \myemph<2>{shared state: semaphore tracks a count}
    \end{itemize}
\item<3-> \myemph<3>{add cond var for each reason we wait}
    \begin{itemize}
    \item semaphore: wait for count to become positive (for down)
    \end{itemize}
\item<4-> \myemph<4>{wait} using condvar; \myemph<5>{broadcast/signal} when condition changes
\end{itemize}
\end{frame}

