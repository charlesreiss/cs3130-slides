\begin{frame}[fragile,label=compReorder]{compilers move loads/stores (1)}
\begin{lstlisting}[language=C++,style=small,
    moredelim={**[is][\btHL<2|handout:2>]{@2}{2@}},
    moredelim={**[is][\btHL<3|handout:3>]{@3}{3@}},
    moredelim={**[is][\btHL<4|handout:4>]{@4}{4@}},
    moredelim={**[is][\btHL<5|handout:5>]{@5}{5@}},
]
void Alice() {
    note_from_alice = 1;
    @2do {} while (note_from_bob);2@
    if (no_milk) {++milk;}
}
\end{lstlisting}
\hrule
\begin{lstlisting}[language=myasm,style=smaller,
    moredelim={**[is][\btHL<2|handout:2>]{@2}{2@}},
    moredelim={**[is][\btHL<3|handout:3>]{@3}{3@}},
    moredelim={**[is][\btHL<4|handout:4>]{@4}{4@}},
    moredelim={**[is][\btHL<5|handout:5>]{@5}{5@}},
]
Alice:
  movl $1, note_from_alice  // note_from_alice <- 1
  movl note_from_bob, %eax  // eax <- note_from_bob
.L2:
  @2testl %eax, %eax2@
  @2jne .L22@                   // while (eax == 0) repeat
  cmpl $0, no_milk          // if (no_milk != 0) ...
  ...
\end{lstlisting}
\end{frame}

\begin{frame}[fragile,label=compReorder2]{compilers move loads/stores too (2)}
\begin{lstlisting}[language=C++,style=smaller,
    moredelim={**[is][\btHL<2|handout:2>]{@2}{2@}},
    moredelim={**[is][\btHL<3|handout:3>]{@3}{3@}},
    moredelim={**[is][\btHL<4|handout:4>]{@4}{4@}},
    moredelim={**[is][\btHL<5|handout:5>]{@5}{5@}},
]
void Alice() {
    @3note_from_alice = 1;3@  // "Alice waiting" signal for Bob()
    do {} while (note_from_bob);
    if (no_milk) {++milk;}
    @2note_from_alice = 2;2@
}
\end{lstlisting}
\hrule
\begin{lstlisting}[language=myasm,style=smaller,
    moredelim={**[is][\btHL<2|handout:2>]{@2}{2@}},
    moredelim={**[is][\btHL<3|handout:3>]{@3}{3@}},
    moredelim={**[is][\btHL<4|handout:4>]{@4}{4@}},
    moredelim={**[is][\btHL<5|handout:5>]{@5}{5@}},
]
Alice:  
  // compiler optimization: don't set note_from_alice to 1,
  // (why? it will be set to 2 anyway)
  @3movl note_from_bob, %eax3@  // eax <- note_from_bob
.L2:
  testl %eax, %eax          
  jne .L2                   // while (eax == 0) repeat
  ...
  @2movl $2, note_from_alice2@  // note_from_alice <- 2
\end{lstlisting}
\end{frame}
